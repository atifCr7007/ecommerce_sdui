# Kong Gateway Routes Configuration for OneMart SDUI App
# This file defines the API routes that Kong Gateway will manage
# for the ecommerce application.

# Services Configuration
services:
  - name: medusa-service
    url: http://medusa-backend:9000
    protocol: http
    host: medusa-backend
    port: 9000
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000

  - name: auth-service
    url: http://auth-backend:3001
    protocol: http
    host: auth-backend
    port: 3001
    path: /
    retries: 3
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000

# Routes Configuration
routes:
  # Product Routes
  - name: products-list
    service: medusa-service
    paths: ["/api/products"]
    methods: ["GET"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]
    
  - name: product-detail
    service: medusa-service
    paths: ["/api/products/(?<product_id>[^/]+)"]
    methods: ["GET"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]

  # Category Routes
  - name: categories-list
    service: medusa-service
    paths: ["/api/categories"]
    methods: ["GET"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]
    
  - name: category-detail
    service: medusa-service
    paths: ["/api/categories/(?<category_id>[^/]+)"]
    methods: ["GET"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]

  # Cart Routes
  - name: cart-operations
    service: medusa-service
    paths: ["/api/cart"]
    methods: ["GET", "POST", "PUT", "DELETE"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]
    
  - name: cart-items
    service: medusa-service
    paths: ["/api/cart/(?<cart_id>[^/]+)/items"]
    methods: ["POST", "PUT", "DELETE"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]

  # Search Routes
  - name: product-search
    service: medusa-service
    paths: ["/api/search"]
    methods: ["GET"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]

  # Authentication Routes
  - name: auth-login
    service: auth-service
    paths: ["/api/auth/login"]
    methods: ["POST"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]
    
  - name: auth-register
    service: auth-service
    paths: ["/api/auth/register"]
    methods: ["POST"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]
    
  - name: auth-logout
    service: auth-service
    paths: ["/api/auth/logout"]
    methods: ["POST"]
    methods: ["DELETE"]
    strip_path: true
    preserve_host: false
    protocols: ["http", "https"]

# Plugins Configuration
plugins:
  # Rate Limiting
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      day: 10000
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # CORS
  - name: cors
    config:
      origins: ["*"]
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      headers: ["Accept", "Accept-Version", "Content-Length", "Content-MD5", "Content-Type", "Date", "X-Auth-Token", "Authorization"]
      exposed_headers: ["X-Auth-Token"]
      credentials: true
      max_age: 3600

  # Request/Response Logging
  - name: file-log
    config:
      path: /var/log/kong/access.log
      reopen: true

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10

  # Response Rate Limiting
  - name: response-ratelimiting
    config:
      limits:
        video: 
          minute: 10
        image:
          minute: 20

# Global Configuration
_format_version: "3.0"
_transform: true

# Load Balancing Configuration
upstreams:
  - name: medusa-upstream
    algorithm: round-robin
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 3
        unhealthy:
          interval: 10
          http_failures: 3
          timeouts: 3
      passive:
        healthy:
          successes: 3
        unhealthy:
          http_failures: 3
          timeouts: 3
    targets:
      - target: medusa-backend:9000
        weight: 100

  - name: auth-upstream
    algorithm: round-robin
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 3
        unhealthy:
          interval: 10
          http_failures: 3
          timeouts: 3
    targets:
      - target: auth-backend:3001
        weight: 100

# Security Configuration
certificates:
  - cert: |
      -----BEGIN CERTIFICATE-----
      # SSL Certificate for HTTPS
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      # Private Key for HTTPS
      -----END PRIVATE KEY-----
    snis:
      - api.onemart.com
      - "*.onemart.com"

# Consumer Configuration (for API key management)
consumers:
  - username: mobile-app
    custom_id: onemart-mobile-v1
    
  - username: web-app
    custom_id: onemart-web-v1

# API Key Authentication
key-auths:
  - consumer: mobile-app
    key: mobile-api-key-2024
    
  - consumer: web-app
    key: web-api-key-2024

# JWT Authentication Configuration
jwt_secrets:
  - consumer: mobile-app
    algorithm: HS256
    key: mobile-jwt-key
    secret: your-jwt-secret-key-here
    
  - consumer: web-app
    algorithm: HS256
    key: web-jwt-key
    secret: your-jwt-secret-key-here

# Environment-specific overrides
environments:
  development:
    services:
      - name: medusa-service
        url: http://localhost:9000
    plugins:
      - name: rate-limiting
        config:
          minute: 1000  # Higher limits for development
          
  staging:
    services:
      - name: medusa-service
        url: https://staging-api.onemart.com
    plugins:
      - name: rate-limiting
        config:
          minute: 500
          
  production:
    services:
      - name: medusa-service
        url: https://api.onemart.com
    plugins:
      - name: rate-limiting
        config:
          minute: 100  # Stricter limits for production
